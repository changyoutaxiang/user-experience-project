# 用户体验拯救项目 - 优化与修复规划

**文档版本**: v1.0
**创建日期**: 2025-10-23
**基于**: [体检报告.md](体检报告.md)
**当前项目评分**: ⭐⭐⭐⭐ (4.1/5)
**目标评分**: ⭐⭐⭐⭐⭐ (4.8+/5)

---

## 📊 执行摘要

根据项目体检报告，本项目整体质量良好，架构清晰、文档完善，但存在一些关键问题阻碍生产部署。本规划将问题分为三个优先级，并制定了为期2个月的改进计划，旨在将项目从"良好"提升至"优秀"状态。

### 当前状态评估

| 类别 | 现状 | 目标 | 差距 |
|------|------|------|------|
| 部署就绪度 | ⭐⭐⭐ (3/5) | ⭐⭐⭐⭐⭐ (5/5) | 缺Docker文件 |
| 测试覆盖率 | ⭐⭐ (0%) | ⭐⭐⭐⭐ (80%+) | 缺所有测试 |
| CI/CD | ❌ 无 | ✅ 完整 | 需配置 |
| 依赖管理 | ⭐⭐⭐⭐ (4/5) | ⭐⭐⭐⭐⭐ (5/5) | 缺锁文件 |
| 安全加固 | ⭐⭐⭐⭐ (4/5) | ⭐⭐⭐⭐⭐ (5/5) | 需生产配置 |

### 问题优先级分布

- 🚨 **紧急（P0）**: 2项 - 阻塞生产部署
- ⚠️ **重要（P1）**: 3项 - 影响质量和稳定性
- 💡 **优化（P2）**: 10项 - 提升体验和性能

---

## 🚨 第一阶段：紧急修复（P0）

**时间线**: 第1-2周
**目标**: 解除部署阻塞，建立基础质量保障

### 任务 1.1：创建 Dockerfile 配置

**优先级**: 🚨 P0
**预计工时**: 4小时
**负责模块**: DevOps/部署

#### 问题描述
- `docker-compose.yml` 引用的 Dockerfile 路径不存在
- 无法通过 Docker 进行本地开发和部署
- 阻塞 Railway 和其他容器化部署

#### 实施步骤

1. **创建 docker 目录结构**
   ```bash
   mkdir -p docker
   ```

2. **创建 backend.Dockerfile**

   位置: `docker/backend.Dockerfile`

   关键配置：
   - 基础镜像: `python:3.11-slim`
   - 工作目录: `/app`
   - 依赖安装: `requirements.txt`
   - 暴露端口: 8000
   - 启动命令: `uvicorn api.main:app --host 0.0.0.0 --port 8000`
   - 多阶段构建优化镜像大小
   - 非 root 用户运行

3. **创建 frontend.Dockerfile**

   位置: `docker/frontend.Dockerfile`

   关键配置：
   - 构建阶段: `node:18-alpine`
   - 生产阶段: `nginx:alpine`
   - 构建命令: `npm run build`
   - Nginx 配置: SPA 路由支持
   - 环境变量注入支持

4. **创建 .dockerignore 文件**

   后端排除：
   - `__pycache__/`, `*.pyc`, `venv/`, `.pytest_cache/`

   前端排除：
   - `node_modules/`, `dist/`, `.cache/`

5. **更新 docker-compose.yml**

   修正构建上下文路径：
   ```yaml
   backend:
     build:
       context: ./backend
       dockerfile: ../docker/backend.Dockerfile

   frontend:
     build:
       context: ./frontend
       dockerfile: ../docker/frontend.Dockerfile
   ```

6. **验证构建**
   ```bash
   # 单独构建测试
   docker build -f docker/backend.Dockerfile -t ux-rescue-backend ./backend
   docker build -f docker/frontend.Dockerfile -t ux-rescue-frontend ./frontend

   # 完整编排测试
   docker-compose up --build
   ```

#### 验收标准
- [ ] `docker/backend.Dockerfile` 存在且可构建
- [ ] `docker/frontend.Dockerfile` 存在且可构建
- [ ] `docker-compose up` 成功启动所有服务
- [ ] 后端健康检查通过 (http://localhost:8000/health)
- [ ] 前端可访问 (http://localhost:5173)
- [ ] 数据库连接正常

#### 预期成果
- ✅ Docker 本地开发环境可用
- ✅ 部署阻塞解除
- ✅ 部署就绪度: 3/5 → 4/5

---

### 任务 1.2：添加基础测试框架

**优先级**: 🚨 P0
**预计工时**: 8小时
**负责模块**: 质量保障

#### 问题描述
- 当前测试覆盖率: 0%
- 代码质量无法保证
- 重构和迭代风险高

#### 实施步骤

##### 后端测试（5个核心API测试）

1. **创建测试目录结构**
   ```bash
   mkdir -p backend/tests/{api,services,models,utils}
   touch backend/tests/__init__.py
   touch backend/tests/conftest.py
   ```

2. **配置 pytest (conftest.py)**
   ```python
   # 测试数据库 fixture
   # 测试客户端 fixture
   # 认证 token fixture
   # 测试用户 fixture
   ```

3. **创建 5 个核心 API 测试**

   **tests/api/test_auth.py**:
   - `test_register_user()` - 用户注册
   - `test_login_success()` - 登录成功
   - `test_login_invalid_credentials()` - 登录失败

   **tests/api/test_projects.py**:
   - `test_create_project()` - 创建项目
   - `test_list_projects()` - 项目列表
   - `test_update_project()` - 更新项目

   **tests/api/test_tasks.py**:
   - `test_create_task()` - 创建任务
   - `test_assign_task()` - 分配任务

   **tests/services/test_project_service.py**:
   - `test_calculate_project_progress()` - 进度计算

   **tests/models/test_user_model.py**:
   - `test_password_hashing()` - 密码加密

4. **配置测试运行脚本**

   在 `backend/pyproject.toml` 确认：
   ```toml
   [tool.pytest.ini_options]
   testpaths = ["tests"]
   python_files = ["test_*.py"]
   python_classes = ["Test*"]
   python_functions = ["test_*"]
   ```

5. **运行测试**
   ```bash
   cd backend
   pytest tests/ -v --cov=src --cov-report=html
   ```

##### 前端测试（3个核心组件测试）

1. **创建测试目录**
   ```bash
   mkdir -p frontend/src/__tests__/{components,hooks,utils}
   ```

2. **配置 Vitest**

   确认 `vite.config.ts` 包含测试配置

3. **创建 3 个组件测试**

   **src/__tests__/components/LoginForm.test.tsx**:
   - 渲染测试
   - 表单提交测试
   - 验证错误测试

   **src/__tests__/components/ProjectCard.test.tsx**:
   - 项目信息显示测试
   - 进度条渲染测试

   **src/__tests__/hooks/useAuth.test.ts**:
   - 登录状态管理测试
   - Token 存储测试

4. **运行测试**
   ```bash
   cd frontend
   npm run test
   ```

#### 验收标准
- [ ] 后端至少 8 个测试通过
- [ ] 前端至少 5 个测试通过
- [ ] pytest 配置正确
- [ ] vitest 配置正确
- [ ] 测试可通过 npm/pytest 命令运行
- [ ] 测试覆盖率报告生成

#### 预期成果
- ✅ 核心功能有测试保护
- ✅ 测试覆盖率: 0% → 30%
- ✅ 代码质量得分: 4/5 → 4.5/5

---

### 任务 1.3：安装和锁定前端依赖

**优先级**: 🚨 P0
**预计工时**: 0.5小时
**负责模块**: 前端

#### 问题描述
- `node_modules/` 未安装
- `package-lock.json` 缺失
- 依赖版本不一致风险

#### 实施步骤

1. **安装依赖**
   ```bash
   cd frontend
   npm install
   ```

2. **生成锁文件**
   ```bash
   # 自动生成 package-lock.json
   npm install
   ```

3. **更新 .gitignore**
   ```bash
   # 确保 package-lock.json 不被忽略
   # 移除 package-lock.json 从 .gitignore（如果有）
   ```

4. **验证安装**
   ```bash
   npm run dev
   npm run build
   npm run lint
   ```

5. **提交锁文件**
   ```bash
   git add package-lock.json
   git commit -m "chore: Add package-lock.json for dependency locking"
   ```

#### 验收标准
- [ ] `node_modules/` 目录存在
- [ ] `package-lock.json` 存在且已提交
- [ ] `npm run dev` 成功启动
- [ ] `npm run build` 成功构建
- [ ] 构建产物在 `dist/` 目录

#### 预期成果
- ✅ 前端可本地运行
- ✅ 依赖版本锁定
- ✅ 依赖管理得分: 4/5 → 5/5

---

### 第一阶段总结

**预计完成时间**: 2周
**总工时**: 12.5小时
**关键里程碑**:
- ✅ Docker 完整配置
- ✅ 基础测试框架
- ✅ 前端依赖就绪

**阶段产出**:
- Dockerfile × 2
- 测试文件 × 8+
- package-lock.json
- 测试覆盖率报告

**评分提升**:
- 部署就绪度: 3/5 → 4/5
- 测试质量: 2/5 → 3/5
- 依赖管理: 4/5 → 5/5
- **综合评分**: 4.1/5 → 4.4/5

---

## ⚠️ 第二阶段：质量提升（P1）

**时间线**: 第3-6周
**目标**: 建立完整的质量保障体系和自动化流程

### 任务 2.1：完善测试覆盖率

**优先级**: ⚠️ P1
**预计工时**: 24小时
**负责模块**: 开发团队

#### 目标
- 后端单元测试覆盖率 > 80%
- 前端组件测试覆盖率 > 70%
- 集成测试覆盖核心流程
- E2E 测试覆盖关键用户路径

#### 实施计划

##### 后端测试扩展（16小时）

**API 层测试** (6小时):
- [ ] `test_users_api.py` - 用户管理 CRUD (6个测试)
- [ ] `test_projects_api.py` - 项目管理完整流程 (10个测试)
- [ ] `test_tasks_api.py` - 任务管理完整流程 (12个测试)
- [ ] `test_expenses_api.py` - 支出管理 (8个测试)
- [ ] `test_documents_api.py` - 文档管理 (6个测试)
- [ ] `test_audit_logs_api.py` - 审计日志 (4个测试)

**Service 层测试** (6小时):
- [ ] `test_auth_service.py` - 认证服务 (8个测试)
- [ ] `test_project_service.py` - 项目业务逻辑 (10个测试)
- [ ] `test_task_service.py` - 任务业务逻辑 (8个测试)
- [ ] `test_budget_service.py` - 预算计算 (6个测试)
- [ ] `test_notification_service.py` - 通知服务 (4个测试)

**Model 层测试** (2小时):
- [ ] `test_user_model.py` - 用户模型验证
- [ ] `test_project_model.py` - 项目模型验证
- [ ] `test_task_model.py` - 任务模型验证
- [ ] `test_expense_model.py` - 支出模型验证

**集成测试** (2小时):
- [ ] `test_project_workflow.py` - 项目完整工作流
- [ ] `test_task_assignment_workflow.py` - 任务分配流程
- [ ] `test_budget_tracking_workflow.py` - 预算跟踪流程

##### 前端测试扩展（8小时）

**组件测试** (4小时):
- [ ] `LoginForm.test.tsx` - 登录表单
- [ ] `ProjectForm.test.tsx` - 项目表单
- [ ] `TaskCard.test.tsx` - 任务卡片
- [ ] `BudgetChart.test.tsx` - 预算图表
- [ ] `DocumentList.test.tsx` - 文档列表
- [ ] `Navbar.test.tsx` - 导航栏
- [ ] `Sidebar.test.tsx` - 侧边栏

**Hooks 测试** (2小时):
- [ ] `useAuth.test.ts` - 认证 Hook
- [ ] `useProjects.test.ts` - 项目 Hook
- [ ] `useTasks.test.ts` - 任务 Hook
- [ ] `useApi.test.ts` - API Hook

**工具函数测试** (1小时):
- [ ] `date.test.ts` - 日期工具
- [ ] `currency.test.ts` - 货币格式化
- [ ] `validation.test.ts` - 验证函数

**E2E 测试（Playwright）** (1小时):
- [ ] 安装 Playwright: `npm install -D @playwright/test`
- [ ] 配置 `playwright.config.ts`
- [ ] 创建测试:
  - `e2e/login.spec.ts` - 登录流程
  - `e2e/project-creation.spec.ts` - 创建项目
  - `e2e/task-management.spec.ts` - 任务管理

#### 测试工具配置

**后端**:
```bash
# 测试覆盖率配置
pip install pytest-cov coverage

# 运行测试
pytest tests/ -v --cov=src --cov-report=html --cov-report=term
```

**前端**:
```json
// package.json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:e2e": "playwright test"
  }
}
```

#### 验收标准
- [ ] 后端测试覆盖率 ≥ 80%
- [ ] 前端测试覆盖率 ≥ 70%
- [ ] 所有测试通过
- [ ] 覆盖率报告生成
- [ ] E2E 测试通过

#### 预期成果
- ✅ 测试质量得分: 3/5 → 5/5
- ✅ 代码质量得分: 4.5/5 → 5/5

---

### 任务 2.2：配置 CI/CD 流程

**优先级**: ⚠️ P1
**预计工时**: 6小时
**负责模块**: DevOps

#### 目标
- 自动化测试执行
- 自动化代码质量检查
- 自动化部署到 staging 环境

#### 实施步骤

1. **创建 GitHub Actions 工作流**

   位置: `.github/workflows/`

2. **CI 工作流 (ci.yml)**

   触发条件：
   - Push to main
   - Pull Request

   任务：
   ```yaml
   jobs:
     backend-tests:
       - Setup Python 3.11
       - Install dependencies
       - Run pytest
       - Upload coverage

     frontend-tests:
       - Setup Node 18
       - Install dependencies
       - Run vitest
       - Upload coverage

     code-quality:
       - Run black, isort, mypy (backend)
       - Run ESLint, Prettier (frontend)

     build-docker:
       - Build Docker images
       - Push to registry (optional)
   ```

3. **CD 工作流 (cd.yml)**

   触发条件：
   - Push to main (after CI passes)

   任务：
   ```yaml
   jobs:
     deploy-staging:
       - Build Docker images
       - Deploy to Railway staging
       - Run smoke tests
       - Notify on Slack/Email
   ```

4. **添加状态徽章到 README**
   ```markdown
   ![CI](https://github.com/{user}/{repo}/actions/workflows/ci.yml/badge.svg)
   ![Coverage](https://codecov.io/gh/{user}/{repo}/branch/main/graph/badge.svg)
   ```

5. **配置代码覆盖率报告**
   - 使用 Codecov 或 Coveralls
   - 配置 `.codecov.yml`

#### 验收标准
- [ ] CI workflow 存在并可运行
- [ ] CD workflow 存在并可部署
- [ ] 所有检查通过显示绿勾
- [ ] 覆盖率报告自动上传
- [ ] README 显示状态徽章

#### 预期成果
- ✅ 自动化测试和部署
- ✅ 代码质量自动检查
- ✅ 可维护性得分: 4/5 → 5/5

---

### 任务 2.3：安全加固

**优先级**: ⚠️ P1
**预计工时**: 8小时
**负责模块**: 安全/后端

#### 目标
- 生产环境安全配置
- 添加安全防护中间件
- 依赖漏洞扫描

#### 实施步骤

##### 后端安全加固（6小时）

1. **添加速率限制中间件**
   ```bash
   pip install slowapi
   ```

   配置：
   ```python
   from slowapi import Limiter
   from slowapi.util import get_remote_address

   limiter = Limiter(key_func=get_remote_address)
   app.state.limiter = limiter

   # 登录接口: 5次/分钟
   # API接口: 100次/分钟
   ```

2. **配置 CORS 严格模式**
   ```python
   # 仅允许生产域名
   app.add_middleware(
       CORSMiddleware,
       allow_origins=["https://yourdomain.com"],
       allow_credentials=True,
       allow_methods=["GET", "POST", "PUT", "DELETE"],
       allow_headers=["*"],
   )
   ```

3. **强化 SECRET_KEY 生成**
   ```python
   # backend/src/core/config.py
   import secrets

   SECRET_KEY: str = os.getenv(
       "SECRET_KEY",
       secrets.token_urlsafe(32)  # 生产环境必须设置
   )

   # 启动时验证
   if not os.getenv("SECRET_KEY"):
       raise ValueError("生产环境必须设置 SECRET_KEY")
   ```

4. **添加安全响应头**
   ```python
   from starlette.middleware.trustedhost import TrustedHostMiddleware
   from starlette.middleware.httpsredirect import HTTPSRedirectMiddleware

   # HTTPS 强制重定向（生产环境）
   if settings.ENVIRONMENT == "production":
       app.add_middleware(HTTPSRedirectMiddleware)

   # 安全头部
   @app.middleware("http")
   async def add_security_headers(request, call_next):
       response = await call_next(request)
       response.headers["X-Content-Type-Options"] = "nosniff"
       response.headers["X-Frame-Options"] = "DENY"
       response.headers["X-XSS-Protection"] = "1; mode=block"
       return response
   ```

5. **依赖安全扫描**
   ```bash
   # 安装 safety
   pip install safety

   # 扫描依赖
   safety check --json

   # 添加到 CI
   ```

6. **数据库连接安全**
   ```python
   # 使用 SSL 连接
   SQLALCHEMY_DATABASE_URL = f"postgresql+asyncpg://{user}:{password}@{host}:{port}/{db}?ssl=require"
   ```

##### 前端安全加固（2小时）

1. **环境变量验证**
   ```typescript
   // src/config.ts
   const requiredEnvVars = ['VITE_API_URL'];
   requiredEnvVars.forEach(varName => {
     if (!import.meta.env[varName]) {
       throw new Error(`Missing required env var: ${varName}`);
     }
   });
   ```

2. **XSS 防护**
   ```bash
   npm install dompurify
   ```

   使用：
   ```typescript
   import DOMPurify from 'dompurify';

   // 渲染用户输入前
   const clean = DOMPurify.sanitize(userInput);
   ```

3. **CSP 配置**

   在 Nginx 配置中添加：
   ```nginx
   add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';";
   ```

#### 验收标准
- [ ] 速率限制中间件生效
- [ ] CORS 配置严格
- [ ] SECRET_KEY 强制环境变量
- [ ] HTTPS 重定向配置（生产）
- [ ] 安全头部添加
- [ ] 依赖扫描通过
- [ ] XSS 防护实现

#### 预期成果
- ✅ 安全得分: 4/5 → 5/5
- ✅ 生产就绪度: 4/5 → 5/5

---

### 第二阶段总结

**预计完成时间**: 4周（第3-6周）
**总工时**: 38小时
**关键里程碑**:
- ✅ 测试覆盖率达标 (>80%)
- ✅ CI/CD 流程完整
- ✅ 生产安全加固

**阶段产出**:
- 完整测试套件（80+测试）
- GitHub Actions workflows
- 安全中间件和配置
- 覆盖率报告和徽章

**评分提升**:
- 测试质量: 3/5 → 5/5
- 可维护性: 4/5 → 5/5
- 安全性: 4/5 → 5/5
- **综合评分**: 4.4/5 → 4.7/5

---

## 💡 第三阶段：优化增强（P2）

**时间线**: 第7-10周
**目标**: 性能优化、运维完善、开发体验提升

### 任务 3.1：性能优化

**优先级**: 💡 P2
**预计工时**: 12小时

#### 前端性能优化（8小时）

1. **代码分割（Code Splitting）**
   ```typescript
   // React.lazy 懒加载
   const ProjectsPage = lazy(() => import('./pages/ProjectsPage'));
   const TasksPage = lazy(() => import('./pages/TasksPage'));

   // 路由级别分割
   <Suspense fallback={<Loading />}>
     <Routes>
       <Route path="/projects" element={<ProjectsPage />} />
     </Routes>
   </Suspense>
   ```

2. **图片优化**
   - 使用 WebP 格式
   - 懒加载图片: `loading="lazy"`
   - 响应式图片: `<picture>` 标签

3. **打包优化**
   ```typescript
   // vite.config.ts
   build: {
     rollupOptions: {
       output: {
         manualChunks: {
           'react-vendor': ['react', 'react-dom'],
           'chart-vendor': ['recharts'],
           'ui-vendor': ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu']
         }
       }
     },
     chunkSizeWarningLimit: 1000
   }
   ```

4. **缓存策略**
   ```nginx
   # Nginx 配置
   location /assets/ {
     expires 1y;
     add_header Cache-Control "public, immutable";
   }
   ```

#### 后端性能优化（4小时）

1. **数据库查询优化**
   ```python
   # 使用 joinedload 预加载关联
   from sqlalchemy.orm import joinedload

   projects = await session.execute(
       select(Project)
       .options(joinedload(Project.members))
       .options(joinedload(Project.tasks))
   )
   ```

2. **添加 Redis 缓存**
   ```bash
   pip install redis aioredis
   ```

   实现：
   ```python
   # 缓存项目列表（5分钟）
   @cache(expire=300)
   async def get_projects_list(user_id: str):
       ...
   ```

3. **API 响应压缩**
   ```python
   from starlette.middleware.gzip import GZipMiddleware
   app.add_middleware(GZipMiddleware, minimum_size=1000)
   ```

#### 验收标准
- [ ] Lighthouse 性能得分 > 90
- [ ] 首屏加载时间 < 2秒
- [ ] Bundle size 减少 30%+
- [ ] API 响应时间 < 100ms (P95)
- [ ] 数据库查询优化（N+1 问题解决）

---

### 任务 3.2：监控和日志系统

**优先级**: 💡 P2
**预计工时**: 16小时

#### 实施步骤

1. **添加健康检查端点**
   ```python
   @app.get("/health")
   async def health_check():
       return {
           "status": "healthy",
           "database": await check_db(),
           "redis": await check_redis(),
           "version": "1.0.0",
           "timestamp": datetime.utcnow()
       }
   ```

2. **结构化日志（Structured Logging）**
   ```python
   import structlog

   logger = structlog.get_logger()

   logger.info(
       "user_login",
       user_id=user.id,
       ip_address=request.client.host,
       user_agent=request.headers.get("user-agent")
   )
   ```

3. **错误追踪（Sentry）**
   ```bash
   pip install sentry-sdk
   ```

   配置：
   ```python
   import sentry_sdk
   sentry_sdk.init(
       dsn=os.getenv("SENTRY_DSN"),
       environment=os.getenv("ENVIRONMENT")
   )
   ```

4. **应用监控（Prometheus + Grafana）**
   ```python
   from prometheus_fastapi_instrumentator import Instrumentator

   Instrumentator().instrument(app).expose(app)
   ```

   创建 `docker-compose.monitoring.yml`:
   ```yaml
   services:
     prometheus:
       image: prom/prometheus
       volumes:
         - ./prometheus.yml:/etc/prometheus/prometheus.yml

     grafana:
       image: grafana/grafana
       ports:
         - "3000:3000"
   ```

5. **日志聚合（ELK Stack - 可选）**
   - Elasticsearch: 日志存储
   - Logstash: 日志处理
   - Kibana: 日志查询和可视化

6. **告警配置**
   - 错误率 > 5%
   - 响应时间 P95 > 500ms
   - CPU 使用率 > 80%
   - 内存使用率 > 90%

#### 验收标准
- [ ] 健康检查端点可用
- [ ] 结构化日志实现
- [ ] Sentry 错误追踪配置
- [ ] Prometheus 指标收集
- [ ] Grafana 仪表板创建
- [ ] 告警规则配置

---

### 任务 3.3：文档完善

**优先级**: 💡 P2
**预计工时**: 10小时

#### 实施计划

1. **API 文档自动生成**

   FastAPI 自带 Swagger UI，但需要完善：
   ```python
   @app.post(
       "/api/projects/",
       response_model=ProjectResponse,
       summary="创建新项目",
       description="创建一个新的项目，需要管理员权限",
       responses={
           201: {"description": "项目创建成功"},
           400: {"description": "请求参数错误"},
           401: {"description": "未授权"}
       }
   )
   async def create_project(...):
       """
       创建新项目

       - **name**: 项目名称（必填）
       - **description**: 项目描述
       - **budget**: 预算金额
       """
   ```

2. **架构图和流程图**

   创建 `docs/architecture/` 目录：

   **system-architecture.md**:
   ```mermaid
   graph TB
       Client[前端 React]
       API[后端 FastAPI]
       DB[(PostgreSQL)]
       Redis[(Redis Cache)]

       Client -->|HTTP/JSON| API
       API -->|SQLAlchemy| DB
       API -->|aioredis| Redis
   ```

   **auth-flow.md**: 认证流程图
   **project-workflow.md**: 项目管理流程图
   **data-model-er.md**: ER 图

3. **贡献指南（CONTRIBUTING.md）**
   ```markdown
   # 贡献指南

   ## 开发流程
   1. Fork 项目
   2. 创建功能分支
   3. 编写代码和测试
   4. 提交 PR

   ## 代码规范
   - 后端: Black + isort + mypy
   - 前端: ESLint + Prettier

   ## 测试要求
   - 单元测试覆盖率 > 80%
   - 所有测试必须通过

   ## Commit 规范
   - feat: 新功能
   - fix: 修复
   - docs: 文档
   - test: 测试
   ```

4. **变更日志（CHANGELOG.md）**
   ```markdown
   # Changelog

   ## [1.0.0] - 2025-01-15

   ### Added
   - 完整的项目管理功能
   - 任务分配和追踪
   - 预算管理
   - 审计日志

   ### Security
   - JWT 认证
   - 密码加密
   ```

5. **用户手册**

   创建 `docs/user-guide/`:
   - `getting-started.md` - 快速开始
   - `project-management.md` - 项目管理指南
   - `task-management.md` - 任务管理指南
   - `budget-tracking.md` - 预算追踪指南
   - `troubleshooting.md` - 故障排查

#### 验收标准
- [ ] API 文档完整且实时更新
- [ ] 架构图清晰可读
- [ ] CONTRIBUTING.md 存在
- [ ] CHANGELOG.md 维护
- [ ] 用户手册完整

---

### 任务 3.4：开发体验优化

**优先级**: 💡 P2
**预计工时**: 6小时

#### 实施步骤

1. **Pre-commit Hooks**
   ```bash
   pip install pre-commit
   ```

   创建 `.pre-commit-config.yaml`:
   ```yaml
   repos:
     - repo: https://github.com/psf/black
       rev: 23.12.1
       hooks:
         - id: black

     - repo: https://github.com/pycqa/isort
       rev: 5.13.2
       hooks:
         - id: isort

     - repo: https://github.com/pre-commit/mirrors-eslint
       rev: v8.56.0
       hooks:
         - id: eslint
           files: \.(js|jsx|ts|tsx)$
   ```

   安装：
   ```bash
   pre-commit install
   ```

2. **Husky 配置（前端）**
   ```bash
   npm install -D husky lint-staged
   npx husky install
   ```

   `package.json`:
   ```json
   {
     "lint-staged": {
       "*.{js,jsx,ts,tsx}": ["eslint --fix", "prettier --write"],
       "*.{json,md}": ["prettier --write"]
     }
   }
   ```

3. **Commitlint**
   ```bash
   npm install -D @commitlint/cli @commitlint/config-conventional
   ```

   `.commitlintrc.json`:
   ```json
   {
     "extends": ["@commitlint/config-conventional"]
   }
   ```

4. **代码审查清单**

   创建 `.github/PULL_REQUEST_TEMPLATE.md`:
   ```markdown
   ## 变更说明

   ## 测试
   - [ ] 单元测试通过
   - [ ] 集成测试通过
   - [ ] 手动测试通过

   ## 检查清单
   - [ ] 代码符合规范
   - [ ] 添加了测试
   - [ ] 更新了文档
   - [ ] 无安全漏洞
   ```

5. **VS Code 工作区配置**

   `.vscode/settings.json`:
   ```json
   {
     "python.formatting.provider": "black",
     "python.linting.enabled": true,
     "python.linting.mypyEnabled": true,
     "editor.formatOnSave": true,
     "editor.codeActionsOnSave": {
       "source.organizeImports": true
     }
   }
   ```

#### 验收标准
- [ ] Pre-commit hooks 工作
- [ ] Husky 配置生效
- [ ] Commitlint 强制执行
- [ ] PR 模板存在
- [ ] VS Code 配置完整

---

### 任务 3.5：数据库备份和恢复

**优先级**: 💡 P2
**预计工时**: 4小时

#### 实施步骤

1. **创建备份脚本**

   `scripts/backup-db.sh`:
   ```bash
   #!/bin/bash
   BACKUP_DIR="/backups"
   TIMESTAMP=$(date +%Y%m%d_%H%M%S)
   BACKUP_FILE="$BACKUP_DIR/ux_rescue_$TIMESTAMP.sql.gz"

   pg_dump $DATABASE_URL | gzip > $BACKUP_FILE

   # 保留最近 30 天备份
   find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
   ```

2. **创建恢复脚本**

   `scripts/restore-db.sh`:
   ```bash
   #!/bin/bash
   BACKUP_FILE=$1

   gunzip -c $BACKUP_FILE | psql $DATABASE_URL
   ```

3. **自动备份（Cron）**
   ```bash
   # 每天凌晨 2 点备份
   0 2 * * * /app/scripts/backup-db.sh
   ```

4. **备份到云存储（可选）**
   ```bash
   # 上传到 S3
   aws s3 cp $BACKUP_FILE s3://your-bucket/backups/
   ```

#### 验收标准
- [ ] 备份脚本可执行
- [ ] 恢复脚本测试通过
- [ ] 定时任务配置
- [ ] 备份文件验证

---

### 第三阶段总结

**预计完成时间**: 4周（第7-10周）
**总工时**: 48小时
**关键里程碑**:
- ✅ 性能优化完成
- ✅ 监控系统上线
- ✅ 文档体系完善
- ✅ 开发流程规范

**阶段产出**:
- 性能优化方案
- 监控和告警系统
- 完整文档体系
- 开发工具链配置
- 备份恢复方案

**评分提升**:
- 前端性能: 提升 40%+
- 可观测性: 完整监控和日志
- 文档完整性: 5/5（保持）
- **综合评分**: 4.7/5 → 4.9/5

---

## 📊 总体进度规划

### 甘特图

```
周次 | 阶段 | 任务
-----|------|------
W1   | P0   | ████ Dockerfile
W2   | P0   | ████ 基础测试 + 前端依赖
W3   | P1   | ████ 测试扩展
W4   | P1   | ████ 测试扩展
W5   | P1   | ████ CI/CD + 安全加固
W6   | P1   | ████ 安全加固
W7   | P2   | ████ 性能优化
W8   | P2   | ████ 监控系统
W9   | P2   | ████ 文档完善
W10  | P2   | ████ 开发体验 + 备份
```

### 工时分配

| 阶段 | 任务数 | 预计工时 | 实际工时 | 偏差 |
|------|--------|----------|----------|------|
| P0 紧急修复 | 3 | 12.5h | - | - |
| P1 质量提升 | 3 | 38h | - | - |
| P2 优化增强 | 5 | 48h | - | - |
| **总计** | **11** | **98.5h** | - | - |

### 里程碑

| 里程碑 | 时间 | 关键成果 | 评分目标 |
|--------|------|----------|----------|
| 🚀 M1: 部署就绪 | Week 2 | Docker + 基础测试 | 4.4/5 |
| 🎯 M2: 质量达标 | Week 6 | 测试80% + CI/CD + 安全 | 4.7/5 |
| 🏆 M3: 生产优秀 | Week 10 | 性能优化 + 监控 + 文档 | 4.9/5 |

---

## ✅ 验收标准总览

### 必须完成（P0 + P1）

- [ ] **Docker 配置完整**
  - backend.Dockerfile 存在且可构建
  - frontend.Dockerfile 存在且可构建
  - docker-compose.yml 工作正常

- [ ] **测试覆盖率达标**
  - 后端测试覆盖率 ≥ 80%
  - 前端测试覆盖率 ≥ 70%
  - 所有测试通过

- [ ] **CI/CD 流程完整**
  - GitHub Actions 配置
  - 自动测试执行
  - 自动部署到 staging

- [ ] **安全加固完成**
  - 速率限制
  - HTTPS 配置
  - 安全头部
  - 依赖扫描

- [ ] **前端依赖锁定**
  - package-lock.json 存在
  - node_modules 安装

### 推荐完成（P2）

- [ ] 性能优化（Lighthouse > 90）
- [ ] 监控系统上线
- [ ] 文档完善（API + 架构图）
- [ ] 开发工具链配置
- [ ] 数据库备份方案

---

## 📈 预期成果

### 评分对比

| 维度 | 当前 | 目标 | 提升 |
|------|------|------|------|
| 项目结构 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | - |
| 代码质量 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | +1 |
| 文档完整性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | - |
| 依赖管理 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | +1 |
| 安全性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | +1 |
| 可维护性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | +1 |
| 部署就绪 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | +2 |
| 测试质量 | ⭐⭐ | ⭐⭐⭐⭐⭐ | +3 |

**综合评分**: 4.1/5 → 4.9/5 (提升 19%)

### 量化指标

| 指标 | 当前 | 目标 | 改进 |
|------|------|------|------|
| 测试覆盖率 | 0% | 80%+ | +80% |
| Lighthouse 得分 | 未知 | 90+ | - |
| API 响应时间 (P95) | 未知 | <100ms | - |
| 部署时间 | 手动 | <5min | 自动化 |
| 错误率 | 未知 | <1% | 监控 |
| 文档页数 | 30 | 40+ | +10+ |

---

## 🎯 下一步行动

### 本周立即开始

1. **今天**: 创建 Docker 配置
   - [ ] 创建 `docker/backend.Dockerfile`
   - [ ] 创建 `docker/frontend.Dockerfile`
   - [ ] 测试 Docker 构建

2. **明天**: 安装前端依赖
   - [ ] `cd frontend && npm install`
   - [ ] 生成 package-lock.json
   - [ ] 提交锁文件

3. **本周内**: 添加基础测试
   - [ ] 后端 8 个测试
   - [ ] 前端 5 个测试
   - [ ] 配置测试运行

### 审查和调整

- **每周五**: 进度审查会议
- **每两周**: 调整优先级
- **每月**: 全面质量审查

### 风险管理

| 风险 | 概率 | 影响 | 应对策略 |
|------|------|------|----------|
| 测试编写耗时超预期 | 高 | 中 | 分批次完成，先核心后边缘 |
| Docker 配置复杂 | 中 | 高 | 参考官方文档，寻求社区帮助 |
| CI/CD 调试困难 | 中 | 中 | 从简单开始，逐步完善 |
| 依赖冲突 | 低 | 低 | 使用锁文件，版本固定 |

---

## 📞 联系和支持

**项目负责人**: [您的名字]
**技术支持**: [技术团队]
**文档维护**: [文档团队]

**相关文档**:
- [体检报告.md](体检报告.md) - 项目健康检查详细报告
- [README.md](README.md) - 项目总体介绍
- [SECURITY.md](SECURITY.md) - 安全指南

---

**规划创建日期**: 2025-10-23
**规划维护**: 每周更新进度
**下次审查**: 2025-10-30

*本规划基于项目体检报告生成，将随项目进展动态调整。*
